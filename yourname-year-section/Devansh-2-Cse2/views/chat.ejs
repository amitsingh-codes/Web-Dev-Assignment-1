<% layout('layout/boilerplate') %>
<div class="chat-container">
    <% if (success || error) { %>
        <div class="flash-messages">
            <% if (success) { %>
                <div class="alert alert-success"><%= success %></div>
            <% } %>
            <% if (error) { %>
                <div class="alert alert-error"><%= error %></div>
            <% } %>
        </div>
    <% } %>
    <h1><i class="fas fa-comments"></i> Your Messages</h1>
    <div class="messages-list">
        <% if (messages && messages.length > 0) { %>
            <% messages.forEach(function(msg) { %>
                <div class="message-bubble <%= msg.sender._id.toString() === user._id.toString() ? 'sent' : 'received' %> <%= !msg.isRead && msg.receiver._id.toString() === user._id.toString() ? 'unread' : '' %>">
                    <div class="message-header">
                        <span class="message-user">
                            <%= msg.sender._id.toString() === user._id.toString() ? 'You' : msg.sender.username %>
                            <% if (!msg.isRead && msg.receiver._id.toString() === user._id.toString()) { %>
                                <span class="unread-badge">New</span>
                            <% } %>
                        </span>
                        <span class="message-time"><%= new Date(msg.timestamp).toLocaleString() %></span>
                    </div>
                    <div class="message-content"><%= msg.content %></div>
                </div>
            <% }) %>
        <% } else { %>
            <p class="no-messages">No messages yet. Start a conversation!</p>
        <% } %>
    </div>
    <% if (success || error) { %>
        <div class="flash-messages">
            <% if (success) { %>
                <div class="alert alert-success"><%= success %></div>
            <% } %>
            <% if (error) { %>
                <div class="alert alert-error"><%= error %></div>
            <% } %>
        </div>
    <% } %>
    <form class="send-message-form" action="/chat/send" method="POST">
        <div class="form-group">
            <label for="receiver">Send to:</label>
            <select name="receiver" id="receiver" required onchange="window.location.href='/chat?user=' + this.value">
                <option value="">Select a contact...</option>
                <% contacts.forEach(function(contact) { %>
                    <option value="<%= contact._id %>" <%= (contact._id.toString() === selectedUser) ? 'selected' : '' %>><%= contact.username %></option>
                <% }) %>
            </select>
        </div>
        <div class="form-group">
            <label for="content">Message:</label>
            <input type="text" name="content" id="content" required placeholder="Type your message...">
        </div>
        <button type="submit" class="chat-btn"><i class="fas fa-paper-plane"></i> Send</button>
    </form>
</div>